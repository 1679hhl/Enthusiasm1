<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>2Dæ²™ç›’å°æ¸¸æˆåŸå‹</title>
<style>
  body {
    background: #88cc88;
    display: flex; flex-direction: column; align-items: center;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 20px;
    user-select: none;
  }
  h1 {
    margin-bottom: 5px;
    color: #264d00;
  }
  canvas {
    background: #aad751;
    border: 3px solid #4a7023;
    image-rendering: pixelated;
    cursor: crosshair;
  }
  #inventory {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  .slot {
    width: 40px; height: 40px;
    border: 2px solid #333;
    background: #eee;
    display: flex; justify-content: center; align-items: center;
    font-weight: bold;
    font-size: 24px;
    cursor: pointer;
    user-select: none;
  }
  .slot.selected {
    border-color: #006600;
    background: #ccffcc;
  }
  #instructions {
    margin-top: 15px;
    font-size: 0.9em;
    color: #333;
    max-width: 500px;
    text-align: center;
    line-height: 1.3;
  }
</style>
</head>
<body>

<h1>ğŸŒ¿ 2Dæ²™ç›’å°æ¸¸æˆåŸå‹</h1>
<canvas id="game" width="640" height="480"></canvas>
<div id="inventory"></div>
<div id="instructions">
  <p><b>æ“ä½œè¯´æ˜ï¼š</b>ç®­å¤´é”®ç§»åŠ¨ç©å®¶<br>
  é¼ æ ‡å·¦é”®æŒ–æ˜æ–¹å—ï¼Œå³é”®æ”¾ç½®å½“å‰èƒŒåŒ…æ–¹å—<br>
  ç‚¹å‡»èƒŒåŒ…åˆ‡æ¢æ”¾ç½®çš„æ–¹å—<br>
  æ¸¸æˆä¼šè‡ªåŠ¨ä¿å­˜åœ°å›¾å’ŒèƒŒåŒ…çŠ¶æ€</p>
</div>

<script>
(() => {
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const tileSize = 32;
  const cols = 20;
  const rows = 15;

  // æ–¹å—ç±»å‹å’Œé¢œè‰²æ˜ å°„
  const BLOCKS = {
    air: {color: "#88cc88", solid: false, symbol: ""},
    grass: {color: "#4CAF50", solid: true, symbol: "ğŸŸ©"},
    dirt: {color: "#8B4513", solid: true, symbol: "ğŸŸ«"},
    stone: {color: "#555555", solid: true, symbol: "â¬›"},
  };
  const blockTypes = ["grass", "dirt", "stone"];

  // åœ°å›¾äºŒç»´æ•°ç»„åˆå§‹åŒ–
  let map = [];

  // ç©å®¶åæ ‡
  let player = {x: 10, y: 7};

  // èƒŒåŒ…è®°å½•æ–¹å—æ•°é‡
  let inventory = {
    grass: 0,
    dirt: 0,
    stone: 0,
  };
  let selectedBlock = "grass";

  // è¯»å–å­˜æ¡£
  function loadGame() {
    const savedMap = localStorage.getItem("sandbox_map");
    const savedInv = localStorage.getItem("sandbox_inventory");
    const savedPlayer = localStorage.getItem("sandbox_player");
    if (savedMap) {
      map = JSON.parse(savedMap);
    } else {
      generateMap();
    }
    if (savedInv) inventory = JSON.parse(savedInv);
    if (savedPlayer) player = JSON.parse(savedPlayer);
  }

  // ä¿å­˜å­˜æ¡£
  function saveGame() {
    localStorage.setItem("sandbox_map", JSON.stringify(map));
    localStorage.setItem("sandbox_inventory", JSON.stringify(inventory));
    localStorage.setItem("sandbox_player", JSON.stringify(player));
  }

  // éšæœºåœ°å›¾ç”Ÿæˆï¼ˆç®€æ˜“ç‰ˆï¼‰
  function generateMap() {
    map = [];
    for(let y=0; y<rows; y++) {
      let row = [];
      for(let x=0; x<cols; x++) {
        if (y > 10) {
          // åœ°åº•å¤šçŸ³å¤´å’Œæ³¥åœŸ
          let rand = Math.random();
          if(rand < 0.6) row.push("dirt");
          else if(rand < 0.9) row.push("stone");
          else row.push("grass");
        } else if (y === 10) {
          row.push("grass");
        } else {
          row.push("air");
        }
      }
      map.push(row);
    }
  }

  // ç»˜åˆ¶åœ°å›¾å’Œç©å®¶
  function draw() {
    for(let y=0; y<rows; y++) {
      for(let x=0; x<cols; x++) {
        let b = map[y][x];
        ctx.fillStyle = BLOCKS[b].color;
        ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize);
        // æ–¹å—è¾¹æ¡†
        if(b !== "air") {
          ctx.strokeStyle = "#3a3a3a";
          ctx.strokeRect(x*tileSize, y*tileSize, tileSize, tileSize);
        }
      }
    }
    // ç”»ç©å®¶ï¼ˆç®€å•ç»¿è‰²æ–¹å—å¸¦çœ¼ç›ï¼‰
    const px = player.x * tileSize;
    const py = player.y * tileSize;
    ctx.fillStyle = "#007700";
    ctx.fillRect(px, py, tileSize, tileSize);
    // çœ¼ç›
    ctx.fillStyle = "#ccffcc";
    ctx.fillRect(px+8, py+8, 6, 6);
    ctx.fillRect(px+18, py+8, 6, 6);
  }

  // èƒŒåŒ…UIåˆ·æ–°
  const invEl = document.getElementById("inventory");
  function refreshInventory() {
    invEl.innerHTML = "";
    for(let block in inventory) {
      const slot = document.createElement("div");
      slot.className = "slot";
      if(block === selectedBlock) slot.classList.add("selected");
      slot.textContent = BLOCKS[block].symbol + (inventory[block] > 0 ? inventory[block] : "");
      slot.title = `${block} (${inventory[block]})`;
      slot.onclick = () => {
        selectedBlock = block;
        refreshInventory();
      };
      invEl.appendChild(slot);
    }
  }

  // åˆ¤æ–­ç©å®¶æ–°ä½ç½®æ˜¯å¦åˆæ³•ï¼ˆä¸èƒ½æ’å¢™ï¼‰
  function canMoveTo(x, y) {
    if(x < 0 || x >= cols || y < 0 || y >= rows) return false;
    return !BLOCKS[map[y][x]].solid;
  }

  // ç©å®¶ç§»åŠ¨å¤„ç†
  window.addEventListener("keydown", e => {
    let nx = player.x;
    let ny = player.y;
    if(e.key === "ArrowUp") ny--;
    else if(e.key === "ArrowDown") ny++;
    else if(e.key === "ArrowLeft") nx--;
    else if(e.key === "ArrowRight") nx++;

    if(canMoveTo(nx, ny)) {
      player.x = nx;
      player.y = ny;
      saveGame();
      draw();
    }
  });

  // é¼ æ ‡ç‚¹å‡»å¤„ç†ï¼ˆæŒ–æ˜å’Œæ”¾ç½®ï¼‰
  canvas.addEventListener("mousedown", e => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const cx = Math.floor((e.clientX - rect.left) / tileSize);
    const cy = Math.floor((e.clientY - rect.top) / tileSize);
    if(cx < 0 || cx >= cols || cy < 0 || cy >= rows) return;

    if(e.button === 0) { // å·¦é”® æŒ–æ˜
      if(map[cy][cx] !== "air" && !(
        player.x === cx && player.y === cy //ä¸èƒ½æŒ–è‡ªå·±ç«™çš„æ ¼å­
      )) {
        let blockType = map[cy][cx];
        map[cy][cx] = "air";
        inventory[blockType]++;
        saveGame();
        refreshInventory();
        draw();
      }
    } else if(e.button === 2) { // å³é”® æ”¾ç½®
      if(map[cy][cx] === "air" && inventory[selectedBlock] > 0) {
        map[cy][cx] = selectedBlock;
        inventory[selectedBlock]--;
        saveGame();
        refreshInventory();
        draw();
      }
    }
  });

  // ç¦ç”¨ç”»å¸ƒé»˜è®¤å³é”®èœå•
  canvas.addEventListener("contextmenu", e => e.preventDefault());

  // åˆå§‹åŒ–æ¸¸æˆ
  loadGame();
  refreshInventory();
  draw();

})();
</script>

</body>
</html>
